{% extends "base.html" %}

{% block title %}Carrito de Compras - Wine Shop{% endblock %}

{% block content %}

{# No cargar filtros personalizados. Cálculo de impuestos/total en la vista. #}

<style>
    .carrito-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin: 2rem 0;
    }

    .carrito-items {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .carrito-item {
        display: grid;
        grid-template-columns: 100px 1fr 100px 100px 50px;
        gap: 1.5rem;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .carrito-item:last-child {
        border-bottom: none;
    }

    .item-imagen {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 5px;
    }

    .item-info h3 {
        color: #722f37;
        margin-bottom: 0.5rem;
    }

    .item-precio {
        color: #d4a574;
        font-weight: 600;
    }

    .item-cantidad {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .item-cantidad input {
        width: 50px;
        text-align: center;
        border: 1px solid #ddd;
        padding: 0.3rem;
    }

    .item-subtotal {
        text-align: right;
        color: #722f37;
        font-weight: 600;
    }

    .item-eliminar {
        text-align: center;
    }

    .item-eliminar button {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 0.75rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .item-eliminar button:hover {
        background: #c0392b;
    }

    .carrito-vacio {
        padding: 3rem 2rem;
        text-align: center;
        color: #999;
    }

    .carrito-vacio h3 {
        color: #722f37;
        margin-bottom: 1rem;
    }

    .resumen {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: fit-content;
        position: sticky;
        top: 100px;
    }

    .resumen h3 {
        color: #722f37;
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
    }

    .resumen-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }

    .resumen-total {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0;
        border-top: 2px solid #722f37;
        margin-top: 1rem;
        font-size: 1.3rem;
        font-weight: 700;
        color: #722f37;
    }

    .resumen .btn {
        width: 100%;
        margin-top: 1.5rem;
    }

    .continuar-comprando {
        text-align: center;
        margin-top: 1rem;
    }

    @media (max-width: 1024px) {
        .carrito-container {
            grid-template-columns: 1fr;
        }

        .resumen {
            position: relative;
            top: 0;
        }
    }

    @media (max-width: 768px) {
        .carrito-item {
            grid-template-columns: 80px 1fr;
            gap: 1rem;
            padding: 1rem;
        }

        .item-imagen {
            width: 80px;
            height: 80px;
            grid-column: 1;
            grid-row: 1 / 3;
        }

        .item-info {
            grid-column: 2;
        }

        .item-precio {
            grid-column: 2;
            grid-row: 2;
            font-size: 0.9rem;
        }

        .item-cantidad,
        .item-subtotal,
        .item-eliminar {
            grid-column: 2;
            grid-row: 3;
            font-size: 0.85rem;
        }
    }
</style>

<div class="container">
    <h1 class="section-title">Mi Carrito de Compras</h1>

    <form id="csrf-form" style="display:none;">{% csrf_token %}</form>

    {% if items %}
    <div class="carrito-container">
        <div class="carrito-items">
            {% for item in items %}
            <div class="carrito-item">
                <img src="{{ item.producto.imagen_url }}" alt="{{ item.producto.nombre }}" class="item-imagen">
                <div class="item-info">
                    <h3>{{ item.producto.nombre }}</h3>
                    <span class="item-precio">${{ item.producto.precio_final|floatformat:2 }}</span>
                </div>
                <div class="item-cantidad">
                    <input type="number" min="1" max="{{ item.producto.stock }}" value="{{ item.cantidad }}" 
                           onchange="actualizarCantidad('{{ item.id }}', this.value)">
                </div>
                <div class="item-subtotal">${{ item.subtotal|floatformat:2 }}</div>
                <div class="item-eliminar">
                    <button type="button" onclick="eliminarDelCarrito('{{ item.id }}')">Eliminar</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="resumen">
            <h3>Resumen</h3>
            <div class="resumen-item">
                <span>Subtotal:</span>
                <span>${{ total|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="resumen-item">
                <span>Envío:</span>
                <span>Gratis</span>
            </div>
            <div class="resumen-item">
                <span>Impuestos (19%):</span>
                <span>${{ impuestos|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="resumen-total">
                <span>Total:</span>
                <span id="totalFinal">${{ total_final|default:"0.00"|floatformat:2 }}</span>
            </div>
            <a href="{% url 'checkout' %}" class="btn btn-primary">Proceder al Pago</a>
            <div class="continuar-comprando">
                <a href="{% url 'catalogo' %}" style="color: #722f37; text-decoration: none;">← Continuar Comprando</a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="carrito-vacio">
        <h3>Tu carrito está vacío</h3>
        <p>Aún no has agregado productos</p>
        <a href="{% url 'catalogo' %}" class="btn btn-primary" style="display: inline-block; margin-top: 1rem;">Ir al Catálogo</a>
    </div>
    {% endif %}
</div>

<script>
    function getCsrfToken(){
        const el = document.querySelector('#csrf-form [name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }

    function actualizarCantidad(itemId, cantidad) {
        cantidad = parseInt(cantidad, 10);
        if (isNaN(cantidad) || cantidad <= 0) {
            if (confirm('¿Eliminar este producto del carrito?')) {
                eliminarDelCarrito(itemId);
            }
            return;
        }

        fetch('{% url "actualizar_carrito" 0 %}'.replace('0', itemId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ cantidad: cantidad })
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('Error: ' + (data.message || 'No se pudo actualizar.'));
        })
        .catch(() => alert('Error de red al actualizar el carrito.'));
    }

    function eliminarDelCarrito(itemId) {
        if (!confirm('Confirmar eliminación del producto del carrito')) return;

        fetch('{% url "eliminar_carrito" 0 %}'.replace('0', itemId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Producto eliminado.');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'No se pudo eliminar.'));
            }
        })
        .catch(() => alert('Error de red al eliminar del carrito.'));
    }
</script>
{% endblock %}
