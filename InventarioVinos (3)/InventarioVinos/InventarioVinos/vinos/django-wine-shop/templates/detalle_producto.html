{% extends "base.html" %}

{% block title %}{{ producto.nombre }} - Wine Shop{% endblock %}

{% block content %}
<style>
    .detalle-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        margin: 2rem 0;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .galeria {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .imagen-principal {
        width: 100%;
        height: 500px;
        object-fit: cover;
        border-radius: 10px;
        background: linear-gradient(135deg, #722f37 0%, #8b4153 100%);
    }

    .imagenes-secundarias {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .imagen-secundaria {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .imagen-secundaria:hover {
        border-color: #d4a574;
        transform: scale(1.05);
    }

    .detalles {
        display: flex;
        flex-direction: column;
    }

    .titulo {
        font-size: 2rem;
        color: #722f37;
        margin-bottom: 0.5rem;
    }

    .rating {
        color: #f39c12;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .precio-box {
        background: linear-gradient(135deg, #722f37 0%, #8b4153 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .precio-box .precio {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .precio-box .precio-original {
        text-decoration: line-through;
        opacity: 0.8;
        margin-right: 0.5rem;
    }

    .precio-box .stock-info {
        font-size: 0.95rem;
        opacity: 0.9;
    }

    .descripcion {
        color: #666;
        line-height: 1.8;
        margin-bottom: 2rem;
    }

    .especificaciones {
        background: #f9f9f9;
        padding: 1.5rem;
        border-radius: 5px;
        margin-bottom: 2rem;
    }

    .especificaciones h4 {
        color: #722f37;
        margin-bottom: 1rem;
    }

    .spec-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }

    .spec-label {
        font-weight: 600;
        color: #722f37;
    }

    .spec-value {
        color: #666;
    }

    .cantidad-selector {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 2rem;
    }

    .cantidad-selector label {
        color: #722f37;
        margin: 0;
    }

    .cantidad-selector input {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #ddd;
        border-radius: 5px;
    }

    .botones {
        display: flex;
        gap: 1rem;
    }

    .botones button, .botones a {
        flex: 1;
        padding: 1rem;
        font-size: 1rem;
    }

    .relacionados {
        margin-top: 3rem;
    }

    .relacionados h3 {
        color: #722f37;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
    }

    @media (max-width: 1024px) {
        .detalle-container {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .botones {
            flex-direction: column;
        }

        .botones button, .botones a {
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        .titulo {
            font-size: 1.5rem;
        }

        .precio-box .precio {
            font-size: 2rem;
        }

        .cantidad-selector {
            flex-direction: column;
        }

        .cantidad-selector input {
            width: 100%;
        }
    }
</style>

<div class="container">
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'catalogo' %}" style="color: #722f37; text-decoration: none;">← Volver al Catálogo</a>
    </div>

    <div class="detalle-container">
        <div class="galeria">
            <img id="imagenPrincipal" src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}" class="imagen-principal">
            <div class="imagenes-secundarias">
                <img src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}" class="imagen-secundaria" onclick="cambiarImagen(this.src)">
                {% if producto.imagen_adicional_1 %}
                <img src="{{ producto.imagen_adicional_1 }}" alt="{{ producto.nombre }}" class="imagen-secundaria" onclick="cambiarImagen(this.src)">
                {% endif %}
                {% if producto.imagen_adicional_2 %}
                <img src="{{ producto.imagen_adicional_2 }}" alt="{{ producto.nombre }}" class="imagen-secundaria" onclick="cambiarImagen(this.src)">
                {% endif %}
            </div>
        </div>

        <div class="detalles">
            <h1 class="titulo">{{ producto.nombre }}</h1>
            <div class="rating">⭐⭐⭐⭐⭐ (142 reseñas)</div>

            <div class="precio-box">
                <div class="precio">
                    {% if producto.precio_oferta %}
                    <span class="precio-original">${{ producto.precio }}</span>
                    {% endif %}
                    ${{ producto.precio_final }}
                </div>
                <div class="stock-info">
                    {% if producto.stock > 0 %}
                    En stock: {{ producto.stock }} disponibles
                    {% else %}
                    Producto Agotado
                    {% endif %}
                </div>
            </div>

            <div class="descripcion">
                {{ producto.descripcion }}
            </div>

            {% if producto.graduacion or producto.pais or producto.vina or producto.cosecha %}
            <div class="especificaciones">
                <h4>Especificaciones del Vino</h4>
                {% if producto.graduacion %}
                <div class="spec-item">
                    <span class="spec-label">Graduación Alcohólica:</span>
                    <span class="spec-value">{{ producto.graduacion }}%</span>
                </div>
                {% endif %}
                {% if producto.pais %}
                <div class="spec-item">
                    <span class="spec-label">País de Origen:</span>
                    <span class="spec-value">{{ producto.pais }}</span>
                </div>
                {% endif %}
                {% if producto.vina %}
                <div class="spec-item">
                    <span class="spec-label">Viña:</span>
                    <span class="spec-value">{{ producto.vina }}</span>
                </div>
                {% endif %}
                {% if producto.cosecha %}
                <div class="spec-item">
                    <span class="spec-label">Cosecha:</span>
                    <span class="spec-value">{{ producto.cosecha }}</span>
                </div>
                {% endif %}
                <div class="spec-item">
                    <span class="spec-label">Categoría:</span>
                    <span class="spec-value">{{ producto.categoria.nombre }}</span>
                </div>
                {% if producto.proveedor %}
                <div class="spec-item">
                    <span class="spec-label">Proveedor:</span>
                    <span class="spec-value">{{ producto.proveedor.nombre }}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if user.is_authenticated %}
            <form id="formAgregar" method="post" style="display: none;">
                {% csrf_token %}
            </form>

            <div class="cantidad-selector">
                <label for="cantidad">Cantidad:</label>
                <input type="number" id="cantidad" name="cantidad" value="1" min="1" max="{{ producto.stock }}">
            </div>

            <div class="botones">
                {% if producto.stock > 0 %}
                <button class="btn btn-primary" onclick="agregarAlCarrito({{ producto.id }})">Agregar al Carrito</button>
                {% else %}
                <button class="btn btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">Agotado</button>
                {% endif %}
                <a href="{% url 'catalogo' %}" class="btn btn-secondary">Continuar Comprando</a>
            </div>
            {% else %}
            <div class="alert alert-info">
                Debes <a href="{% url 'login' %}" style="color: inherit; text-decoration: underline;">iniciar sesión</a> para agregar productos al carrito.
            </div>
            <a href="{% url 'login' %}" class="btn btn-primary" style="display: block; text-align: center;">Iniciar Sesión</a>
            {% endif %}
        </div>
    </div>

    {% if relacionados %}
    <div class="relacionados">
        <h3>Productos Relacionados</h3>
        <div class="grid">
            {% for prod in relacionados %}
            <div class="producto-card">
                <img src="{{ prod.imagen_url }}" alt="{{ prod.nombre }}" class="producto-image">
                <div class="producto-info">
                    {% if prod.precio_oferta %}
                    <span class="descuento-badge">OFERTA</span>
                    {% endif %}
                    <h3 class="producto-nombre">{{ prod.nombre }}</h3>
                    <p class="producto-descripcion">{{ prod.descripcion|truncatewords:10 }}</p>
                    <div class="producto-precio">
                        {% if prod.precio_oferta %}
                        <span class="precio-original">${{ prod.precio }}</span>
                        {% endif %}
                        ${{ prod.precio_final }}
                    </div>
                    <a href="{% url 'detalle_producto' prod.id %}" class="btn btn-primary producto-button">Ver Detalles</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    function cambiarImagen(src) {
        document.getElementById('imagenPrincipal').src = src;
    }

    function agregarAlCarrito(productoId) {
        const cantidad = parseInt(document.getElementById('cantidad').value);
        
    // Use API endpoint that accepts JSON (no URL arg required)
    fetch('{% url "agregar_carrito_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                producto_id: productoId,
                cantidad: cantidad
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                actualizarCarrito();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
